name: Safe: Sync Upstream -> main -> ameego-custom

# Run manually or on a schedule
on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # daily at 06:00 UTC

permissions:
  contents: write

jobs:
  sync-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/gitroomhq/postiz-app.git || true
          git fetch upstream --prune

      - name: Checkout main
        run: git checkout main

      - name: Merge upstream/main into main
        run: |
          # prefer fast-forward; if not possible, do a normal merge without opening editor
          git merge --ff-only upstream/main || git merge upstream/main --no-edit || true

      - name: Push main to origin (if changed)
        run: |
          git push origin main || echo "No changes to push for main"

      - name: Ensure ameego-custom exists locally
        run: |
          git fetch origin
          if git show-ref --verify --quiet refs/heads/ameego-custom; then
            git checkout ameego-custom
          else
            if git ls-remote --exit-code --heads origin ameego-custom; then
              git checkout -b ameego-custom origin/ameego-custom
            else
              git checkout -b ameego-custom
            fi
          fi

      - name: Try merge main into ameego-custom
        id: try_merge
        run: |
          set -e
          if git merge main --no-edit; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "CONFLICT" > merge_conflict_marker.txt
          fi

      - name: Push ameego-custom if merge succeeded
        if: steps.try_merge.outputs.merge_status == 'success'
        run: |
          git push origin ameego-custom

      - name: Create PR if merge had conflicts
        if: steps.try_merge.outputs.merge_status == 'conflict'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-sync main -> ameego-custom (conflicts)"
          title: "Sync: Merge main â†’ ameego-custom (please resolve conflicts)"
          body: |
            Automatic merge of `main` into `ameego-custom` failed due to conflicts.
            Please review and resolve conflicts in this Pull Request.
          base: ameego-custom
          head: main
