name: "Safe: Sync Upstream -> main"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-upstream-main
  cancel-in-progress: false

jobs:
  sync-upstream-into-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set upstream remote and fetch
        shell: bash
        run: |
          set -e
          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream "https://github.com/gitroomhq/postiz-app.git"
          else
            git remote add upstream "https://github.com/gitroomhq/postiz-app.git"
          fi
          git fetch --prune upstream
          git fetch --prune origin

      - name: Clear GitHub App auth header (use PAT)
        shell: bash
        run: |
          set -e
          # Remove Authorization header injected by actions/checkout so our PAT is used
          git config --global --unset-all http.https://github.com/.extraheader || true
      - name: Configure origin with PAT for pushes
        shell: bash
        run: |
          set -e
      - name: Force PAT for all GitHub HTTPS operations
        shell: bash
        run: |
          set -e
          git config --global url."https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git remote set-url origin "https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/${{ github.repository }}.git"
      - name: Align local main to origin/main
        shell: bash
        run: |
          set -e
          if git ls-remote --exit-code --heads origin main >/dev/null 2>&1; then
            git checkout -B main origin/main
          else
            git checkout -B main
          fi

      - name: Try fast-forward merge upstream/main -> main
        id: ff_attempt
        shell: bash
        run: |
          set +e
          if git ls-remote --exit-code --heads upstream main >/dev/null 2>&1; then
            git merge --ff-only upstream/main
            status=$?
            if [ "$status" -eq 0 ]; then
              echo "status=ff" >> "$GITHUB_OUTPUT"
            else
              echo "status=diverged" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "status=no-upstream-main" >> "$GITHUB_OUTPUT"
          fi

      - name: Push main when fast-forward succeeded
        if: steps.ff_attempt.outputs.status == 'ff'
        run: git push "https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main

      - name: Create sync branch from upstream/main (when diverged)
        if: steps.ff_attempt.outputs.status == 'diverged'
        shell: bash
        run: |
          set -e
          BR="sync/upstream-into-main/${{ github.run_id }}"
          git checkout -B "$BR" upstream/main
          git push -u "https://x-access-token:${{ secrets.SYNC_TOKEN }}@github.com/${{ github.repository }}.git" "$BR:$BR" --force-with-lease

      - name: Open PR upstream -> main (when diverged)
        if: steps.ff_attempt.outputs.status == 'diverged'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Use a branch in your fork created from upstream/main
            const headBranch = `sync/upstream-into-main/${{ github.run_id }}`;
            const base = 'main';
            const title = 'Sync: upstream â†’ main (review/resolve if conflicts)';
            const body = [
              'This PR brings upstream/main into your main.',
              '',
              '- Upstream is fetch-only; no pushes to upstream.',
              '- The PR uses a branch in your fork created from upstream/main.',
              '- If GitHub reports conflicts, resolve them in this PR UI.',
              '- After merging, your main will be updated to include upstream changes.',
            ].join('\\n');
            try {
              // Avoid duplicate PRs with the same head/base
              const { data: prs } = await github.rest.pulls.list({
                owner, repo, state: 'open', head: `${owner}:${headBranch}`, base
              });
              if (prs.length > 0) {
                core.info(`Existing PR found: #${prs[0].number}`);
              } else {
                const { data: pr } = await github.rest.pulls.create({
                  owner, repo, title, head: headBranch, base, body
                });
                core.info(`Created PR #${pr.number}`);
              }
            } catch (e) {
              core.setFailed(`Failed to create PR: ${e.message}`);
            }
